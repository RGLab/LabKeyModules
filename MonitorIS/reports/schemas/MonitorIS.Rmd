```{r knitr, echo = FALSE}
knitr::opts_chunk$set(message = FALSE,
                      echo = FALSE,
                      warning = FALSE,
                      fig.align = 'left',
                      fig.height = 12,
                      fig.width = 15)
```

```{r libs, message = FALSE}
library(Rlabkey)
library(ImmuneSpaceR)
library(DT)
library(dplyr)
library(ggplot2)
library(plotly)
library(tidytext)
library(wordcloud)
library(lubridate)
library(readr)
library(stringr)
```

```{r preprocess}
#str(labkey.url.params)

# global
TODAY <- today(tz = "US/Pacific")

# labkey parameters
from <- ifelse(labkey.url.params$from == "",
               as_date("2016-01-01"),
               as_date(labkey.url.params$from))
to <- ifelse(labkey.url.params$to == "",
             TODAY,
             as_date(labkey.url.params$to))
class(from) <- "Date"
class(to) <- "Date"
from <- ifelse(from > to,
               as_/date("2016-01-01"),
               from)
class(from) <- "Date"
from_to <- tibble(date = seq(from, to, by = "1 day"))

plotType <- ifelse(labkey.url.params$plotType %in% c("bar", "line"),
                   labkey.url.params$plotType,
                   "bar")
dateBy <- ifelse(labkey.url.params$by %in% c("day", "week", "month", "year"),
                 labkey.url.params$by,
                 "day")

# exclude admins and support accounts
admins <- labkey.selectRows(baseUrl = labkey.url.base,
                            folderPath = "/home",
                            schemaName = "core",
                            queryName = "SiteUsers",
                            viewName = "",
                            colFilter = makeFilter(c("Groups/Group$SName",
                                                     "CONTAINS_ONE_OF",
                                                     "Developers;Administrators")),
                            containerFilter = NULL)

extra_emails <- paste("rglab.org",
                      "immunespace.org",
                      "labkey.com",
                      "gilguday@comcast.net",
                      "lwolfe@fredhutch.org",
                      "rsautera@fhcrc.org",
                      sep = ";")
extras <- labkey.selectRows(baseUrl = labkey.url.base,
                            folderPath = "/home",
                            schemaName = "core",
                            queryName = "SiteUsers",
                            viewName = "",
                            colFilter = makeFilter(c("Email",
                                                     "CONTAINS_ONE_OF",
                                                     extra_emails)),
                            containerFilter = NULL)

exclusion_list <- paste0(unique(c(admins$`Display Name`, extras$`Display Name`)), collapse = ";")
exclusion_email <- unique(c(admins$Email, extras$Email))
```



# Users
```{r newusers}
users_all <- labkey.selectRows(baseUrl = labkey.url.base,
                               folderPath = "/",
                               schemaName = "core",
                               queryName = "SiteUsers",
                               viewName = "",
                               colFilter = NULL,
                               containerFilter = NULL)
colnames(users_all) <- tolower(chartr(" ", "_", colnames(users_all)))
users_all <- users_all %>%
  mutate(created = as_date(created),
         last_login = as_date(last_login))

users <- users_all %>%
  filter(created >= from & created <= to) %>%
  select(created) %>%
  count(created) %>%
  right_join(from_to, by = c("created" = "date")) %>%
  mutate(n = replace(n, is.na(n), 0)) %>%
  mutate(created = floor_date(created, dateBy)) %>%
  group_by(created) %>%
  summarise(N = sum(n))
p <- users %>%
  plot_ly(x = ~created,
          y = ~N) %>%
  layout(xaxis = list(title = paste0("By ", dateBy)),
         yaxis = list(title = "New users"),
         title = "New users over time")
if (plotType == "line") {
  p %>% add_lines()
} else {
  p %>% add_bars()
}
```

We gained **`r round(mean(users$N), 2)` new users** per *`r dateBy`* on average from `r from` to `r to`.
<br>


```{r activeusers}
logins <- labkey.selectRows(baseUrl = labkey.url.base,
                            folderPath = "/",
                            schemaName = "auditLog",
                            queryName = "UserAuditEvent",
                            viewName = "",
                            colFilter = makeFilter(c("CreatedBy/DisplayName",
                                                     "NOT_IN",
                                                     exclusion_list),
                                                   c("Comment",
                                                     "CONTAINS",
                                                     "Database authentication")),
                            containerFilter= "AllFolders")
logins <- logins %>%
  mutate(Date = as_date(Date)) %>%
  select(Date, `Created By`) %>%
  filter(Date >= from & Date <= to)
active_by <- logins %>%
  distinct() %>%
  count(Date) %>%
  right_join(from_to, by = c("Date" = "date")) %>%
  mutate(n = replace(n, is.na(n), 0)) %>%
  mutate(Date = floor_date(Date, dateBy)) %>%
  group_by(Date) %>%
  summarise(n = sum(n))
p <- active_by %>%
  plot_ly(x = ~Date,
          y = ~n) %>%
  layout(xaxis = list(title = paste0("By ", dateBy)),
         yaxis = list(title = "Active users"),
         title = "Active users over time")
if (plotType == "line") {
  p %>% add_lines()
} else {
  p %>% add_bars()
}
```

We had **`r round(mean(active_by$n), 2)` active users** per *`r dateBy`* on average from `r from` to `r to`.
<br>


```{r logins}
logins_by <- logins %>%
  mutate(Date = floor_date(as_date(Date), dateBy)) %>%
  count(Date, `Created By`) %>%
  left_join(select(users_all, user_id, display_name),
            by = c("Created By" =  "user_id")) %>%
  mutate(display_name = ifelse(is.na(display_name),
                               as.character(`Created By`),
                               display_name)) %>%
  select(Date, display_name, n)

if (nrow(logins_by) > 0) {
  p <- ggplot(logins_by, aes(x = Date, y = n, colour = display_name)) +
    geom_line(alpha = 0.3) +
    xlab(paste0("By ", dateBy)) +
    ylab("# of logins") +
    ggtitle("# of logins by users over time") +
    scale_x_date(limits = c(from, to)) +
    theme_minimal() +
    theme(legend.position = "none")
  ggplotly(p)
#  logins_by %>%
#    plot_ly(x = ~Date, y = ~n, color = ~display_name) %>%
#    layout(xaxis = list(title = paste0("By ", dateBy)),
#           yaxis = list(title = "# of logins"),
#           title = "# of logins by users over time",
#           showlegend = FALSE) %>%
#    add_lines(alpha = 0.3)
}
```
<br>


```{r vs}
#vs <- full_join(df, logins_byday, by = c("created" = "Date")) %>%
#  select(create#n) %>%
#  mutate(N = ifelse(is.na(N), 0, N), n = ifelse(is.na(n), 0, n), surp = n - N)
#p <- ggplot(vs, aes(x = N, y = n)) +
#  geom_point(aes(col = surp, label = created)) +
#  geom_abline(intercept = 0) +
#  theme_IS(base_size = 18)
#ggplotly(p)
```


```{r totalusers}
total_users <- mutate(users, cumsum = cumsum(N))

total_users %>%
  plot_ly(x = ~created, y = ~cumsum) %>%
  layout(xaxis = list(title = paste0("By ", dateBy)),
         yaxis = list(title = "Total # of users"),
         title = "Total # of users over time") %>%
  add_lines(line = list(shape = "hv"))
```
<br>


## Table of users
```{r usertable}
logins_byuser <- logins %>%
  count(`Created By`)

topusers <- users_all %>%
  left_join(logins_byuser,
            by = c("user_id" = "Created By")) %>%
  filter(!is.na(n)) %>%
  arrange(desc(n))

datatable(topusers)
```
<br>



***



# Searches Queries
```{r searches}
searches <- labkey.selectRows(baseUrl = labkey.url.base,
                              folderPath = "/home",
                              schemaName = "auditLog",
                              queryName = "SearchAuditEvent",
                              viewName = "",
                              colSort = "Created",
                              colFilter = makeFilter(c("Query",
                                                       "DOES_NOT_CONTAIN",
                                                       "\\"),
                                                     c("Query",
                                                       "DOES_NOT_CONTAIN",
                                                       "1234"),
                                                     c("CreatedBy/DisplayName",
                                                       "NOT_IN",
                                                       exclusion_list)),
                              containerFilter = NULL)

searches <- searches %>%
  filter(`Created By` != 0,
         Date >= from & Date <= to) %>%
  mutate(id = paste(Date, `Created By`, sep = "-")) %>%
  select(id, Query)
```

## Word cloud
```{r wordcloud}
freq <- searches %>%
  unnest_tokens(output = word, input = Query) %>%
  count(word, sort = T)
pal <- brewer.pal(9,"YlGnBu")
pal <- pal[-(1:4)]

if (nrow(freq) > 0) {
  wordcloud(words = freq$word,
            freq = freq$n,
            max.words = 30,
            rot.per = 0,
            random.order = FALSE,
            colors = pal)
} else {
  wordcloud(words = "no search",
            freq = 1)
}
```
<br>


## Table of search queries
```{r wordtable}
datatable(freq, width = 600)
```
<br>



***



# Studies and Modules
```{r studycount}
folders <- labkey.selectRows(baseUrl = labkey.url.base,
                             folderPath = "/",
                             schemaName = "auditLog",
                             queryName ="ContainerAuditEvent",
                             colNameOpt = "rname",
                             containerFilter = "AllFolders")

sdys <- folders %>%
  filter(!is.na(container)) %>%
  select(created, comment) %>%
  filter(grepl("Folder SDY[0-9].*created$", comment)) %>%
  mutate(study = gsub("\\s.*$", "", gsub("^.*SDY", "SDY", comment))) %>%
  arrange(created) %>%
  mutate(count = 1:nrow(.)) %>%
  filter(created >= "2016-01-01") %>%
  select(created, count) %>%
  mutate(created = as_date(created))

sdys <- bind_rows(tibble(created = as_date("2016-01-01"),
                         count = min(sdys$count)),
                  sdys,
                  tibble(created = TODAY,
                         count = max(sdys$count)))

# Based on folder creation -> counts private studies
sdys %>%
  plot_ly(x = ~created, y = ~count) %>%
  layout(xaxis = list(title = "Date"),
         yaxis = list(title = "Studies"),
         title = "Number of studies available") %>%
  add_lines(line = list(shape = "hv"))
```
<br>


```{r tomcat-logs}
# These logs are actually `/labkey/apps/tomcat/logs/` created by tomcat.
# Since they cannot be access by the r server, we need to copy them to `/share`
# Set up a cron job on `wsP/T` as `immunespace`
# crontab -e
# Add this line
# 00 0-23/6 * * * rsync -a -v /labkey/apps/tomcat/logs/localhost_access_log.* /share/tomcat-logs/
# This will sync logs to `/share/tomcat-logs/` every six hour.
read_log2 <- function(date) {
  if (Sys.info()["nodename"] == "immunetestrserve" && date < "2017-09-22") {
    file_name <- paste0("/share/tomcat-logs/localhost_access_log..", date, ".txt")
    file_name_m <- paste0("/share/tomcat-logs/modified/localhost_access_log..", date, ".txt")
  } else {
    file_name <- paste0("/share/tomcat-logs/localhost_access_log.", date, ".txt")
    file_name_m <- paste0("/share/tomcat-logs/modified/localhost_access_log.", date, ".txt")
  }

  if (file.exists(file_name)) {
    tried <- try(
      read_log(file = file_name,
               col_types = cols(.default = col_character()))
    )

    if (class(tried) == "try-error") {
      if (!file.exists(file_name_m)) {
        original <- file(file_name, "r")
        modified <- file(file_name_m, "w")
        lines <- readLines(original, skipNul = TRUE)
        writeLines(lines, modified)
        close(original)
        close(modified)
      }

      tried <- try(
        read_log(file = file_name_m,
                 col_types = cols(.default = col_character()))
      )
    }

    if (class(tried) == "try-error") {
      NULL
    } else {
      if (nrow(tried) > 0) {
        # delete if the log is still being modfied
        if (date == TODAY) {
          if (file.exists(file_name_m)) {
            file.remove(file_name_m)
          }
        }
        tried %>%
          mutate(date = date,
                 study = str_extract(X5, "SDY\\d+|IS\\d+|Lyoplate"),
                 schema = grepl("schemaName=study?", X5),
                 query = str_extract(X5, "(?<=queryName=)\\w+")) %>%
          filter(!X12 %in% exclusion_email) %>%
          filter(X6 == 200)
      } else {
        NULL
      }
    }
  } else {
    NULL
  }
}

logs_list <- lapply(from_to$date, read_log2)
logs_dt <- bind_rows(logs_list)
```


## Pageviews: Study
```{r study-views}
string <- paste0("(",
                 "/project/Studies/SDY\\d+/begin.view\\?? HTTP/1.1",
                 "|",
                 "/project/Studies/begin.view\\?? HTTP/1.1",
                 "|",
                 "/project/HIPC/IS\\d+/begin.view\\?? HTTP/1.1",
                 "|",
                 "/project/HIPC/Lyoplate/begin.view\\?? HTTP/1.1",
                 ")")

log_study <- logs_dt %>%
  mutate(folder = str_extract(X5, string)) %>%
  filter(!is.na(folder)) %>%
  mutate(study = ifelse(is.na(study), "Data Finder", study)) %>%
  select(study) %>%
  count(study) %>%
  arrange(desc(n))

datatable(log_study,
          colnames = c("Study", "Unique pageviews"),
          caption = paste0("From ", from, " to ", to),
          width = 600)
```


## Pageviews: Module
```{r module-views}
string <- "(?<=GET /)(DataExplorer|GeneExpressionExplorer|GeneSetEnrichmentAnalysis|ImmuneResponsePredictor)(?=/\\S+/begin.view HTTP/1.1)"

log_module <- logs_dt %>%
  mutate(module = str_extract(X5, string)) %>%
  filter(!is.na(module)) %>%
  select(module) %>%
  count(module) %>%
  arrange(desc(n))

datatable(log_module,
          colnames = c("Module", "Unique pageviews"),
          caption = paste0("From ", from, " to ", to),
          width = 600)
```


## Pageviews: Reports
```{r reports-views}
strings <- c(
  "GET /reports/Studies/SDY144/runReport.view\\?reportId=module%3ASDY144%2Freports%2Fschemas%2Fstudy%2Fdemographics%2FHAI_VN_vs_plasma_cells.Rmd HTTP/1.1",
  "GET /reports/Studies/SDY180/runReport.view\\?reportId=module%3ASDY180%2Freports%2Fschemas%2Fstudy%2Fdemographics%2Fplasmablast_abundance.Rmd HTTP/1.1",
  "GET /reports/Studies/SDY207/runReport.view\\?reportId=module%3ASDY207%2Freports%2Fschemas%2Fstudy%2Ffcs_sample_files%2FCyTOF_Visualization.Rmd HTTP/1.1",
  "GET /project/Studies/SDY207/begin.view\\?pageId=Report HTTP/1.1",
  "GET /reports/Studies/SDY269/runReport.view\\?reportId=module%3ASDY269%2Freports%2Fschemas%2Fhai_flow_elispot.Rmd HTTP/1.1",
  "GET /project/HIPC/IS1/begin.view\\?pageId=Report HTTP/1.1")

log_reports <- logs_dt %>%
  mutate(report = X5,
         report = str_replace(report, strings[1], "SDY144"),
         report = str_replace(report, strings[2], "SDY180"),
         report = str_replace(report, strings[3], "SDY207"),
         report = str_replace(report, strings[4], "SDY207"),
         report = str_replace(report, strings[5], "SDY269"),
         report = str_replace(report, strings[6], "IS1")) %>%
  filter(!is.na(report)) %>%
  filter(report %in% c("SDY144", "SDY180", "SDY207", "SDY269", "IS1")) %>%
  select(report) %>%
  count(report) %>%
  arrange(desc(n))

datatable(log_reports,
          colnames = c("Report", "Unique pagesviews"),
          caption = paste0("From ", from, " to ", to),
          width = 600)
```


***



# ImmuneSpaceR

```{r isr}
ISR <- logs_dt %>%
  filter(grepl("ImmuneSpaceR", X11)) %>%
  filter(!is.na(X12)) %>%
  mutate(study = ifelse(is.na(study),
                        "All",
                        study))

ISR_inits <- ISR %>%
  filter(query == "ISC_study_datasets")
```

## Connections

```{r isr-study}
ISR_study <- ISR_inits %>%
  select(study) %>%
  count(study) %>%
  arrange(desc(n))

datatable(ISR_study,
          colnames = c("Study", "ISR connections"),
          caption = paste0("From ", from, " to ", to),
          width = 600)
```
<br>


```{r isr-con}
ISR_con <- ISR_inits %>%
  select(date) %>%
  count(date) %>%
  right_join(from_to, by = "date") %>%
  mutate(n = replace(n, is.na(n), 0)) %>%
  mutate(date = floor_date(date, dateBy)) %>%
  group_by(date) %>%
  summarise(N = sum(n))

p <- ISR_con %>%
  plot_ly(x = ~date,
          y = ~N) %>%
  layout(xaxis = list(title = paste0("By ", dateBy)),
         yaxis = list(title = "# of connections"),
         title = "# of connections over time")
if (plotType == "line") {
  p %>% add_lines()
} else {
  p %>% add_bars()
}
```

We had **`r round(mean(ISR_con$N), 2)` connections** per *`r dateBy`* on average from `r from` to `r to`.
<br>


```{r isr-user}
ISR_user <- ISR_inits %>%
  select(date, X12) %>%
  filter(!is.na(X12)) %>%
  distinct() %>%
  select(date) %>%
  count(date) %>%
  right_join(from_to, by = "date") %>%
  mutate(n = replace(n, is.na(n), 0)) %>%
  mutate(date = floor_date(date, dateBy)) %>%
  group_by(date) %>%
  summarise(N = sum(n))

p <- ISR_user %>%
  plot_ly(x = ~date,
          y = ~N) %>%
  layout(xaxis = list(title = paste0("By ", dateBy)),
         yaxis = list(title = "# of users"),
         title = "# of ISR users over time")
if (plotType == "line") {
  p %>% add_lines()
} else {
  p %>% add_bars()
}
```

We had **`r round(mean(ISR_user$N), 2)` ISR users** per *`r dateBy`* on average from `r from` to `r to`.
<br>

## Table of ISR users

```{r isr-top-users}
ISR_top_user <- ISR_inits %>%
  mutate(email = X12) %>%
  count(email) %>%
  arrange(desc(n))
datatable(ISR_top_user, width = 800)
```

<br>


## Downloads

```{r isr-bioc}
BIOC <- read.table("https://www.bioconductor.org/packages/stats/bioc/ImmuneSpaceR/ImmuneSpaceR_stats.tab", header = TRUE)
BIOC <- BIOC %>%
  filter(Month != "all") %>%
  mutate(date = as_date(paste(Year, Month, "01", sep = "-"), "%Y-%b-%d")) %>%
  arrange(date) %>%
  filter(date <= TODAY) %>%
  select(date, Nb_of_downloads)

p <- BIOC %>%
  plot_ly(x = ~date,
          y = ~Nb_of_downloads) %>%
  layout(xaxis = list(title = paste0("By ", dateBy)),
         yaxis = list(title = "# of downloads"),
         title = "# of downloads in Bioconductor over time")
if (plotType == "line") {
  p %>% add_lines()
} else {
  p %>% add_bars()
}

```
<br>


```{r isr-github}
```


***

# RStudio

```{r rstudio}
log_rstudio <- logs_dt %>%
  filter(grepl("GET /_rstudio/ HTTP/1.1", X5))

session_rstudio <- log_rstudio %>%
  select(date) %>%
  count(date) %>%
  right_join(from_to, by = "date") %>%
  mutate(n = replace(n, is.na(n), 0)) %>%
  mutate(date = floor_date(date, dateBy)) %>%
  group_by(date) %>%
  summarise(N = sum(n))

p <- session_rstudio %>%
  plot_ly(x = ~date,
          y = ~N) %>%
  layout(xaxis = list(title = paste0("By ", dateBy)),
         yaxis = list(title = "# of sessions"),
         title = "# of RStudio sessions over time")
if (plotType == "line") {
  p %>% add_lines()
} else {
  p %>% add_bars()
}
```

We had **`r round(mean(session_rstudio$N), 2)` RStudio sessions** per *`r dateBy`* on average from `r from` to `r to`.



***

# Debuggin Messages

## Missing access logs
```{r debugging-messages}
from_to$date[unlist(lapply(logs_list, is.null))]
```
