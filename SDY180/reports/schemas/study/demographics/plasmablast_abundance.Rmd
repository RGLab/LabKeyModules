```{r cache=FALSE, echo=FALSE}
# Set this variable to true if you are running this script on your own machine
run_locally <- FALSE
```

```{r eval=run_locally, cache=FALSE, echo=FALSE}
# Set your user email (or name)
labkey.user.email <- "Yourname"
```

# Abundance of plasmablasts measured by multiparameter flow cytometry in SDY180
#### Report generated by `r labkey.user.email` on `r date()`

### Summary
This report investigates the abundance of plasmablast (and other B cell subsets) over time after vaccination with Pneumovax, Fluzone, or no vaccination (saline control group). 
It can be seen on the three figures below that the plasmablast subset peaks at day 7 in both vaccine groups, with a stronger and more durable response with Pneumovax. 
As expected, there is no clear peak in the saline group. These results are similar to those reported in Figure 6 B of <a href="http://www.ncbi.nlm.nih.gov/pmc/articles/PMC3681204/" target="_BLANK"> Obermoser et al. (2013)</a> published as part of the original study.


```{r knitr-opts, echo = FALSE, message = FALSE, cache = FALSE}
library(knitr)
opts_chunk$set(cache=TRUE, echo=FALSE, message=FALSE, warning=FALSE,
               fig.width=10, fig.height=14, dpi=100, fig.align="center",
               cache.path=file.path(labkey.file.root, "cache/reports/", labkey.user.email))
```

```{r libraries, cache=FALSE}
# Load the ImmuneSpaceR package
library(ImmuneSpaceR)
library(ggplot2)
library(data.table)
```


```{r connection, cache = TRUE}
study <- CreateConnection(c("SDY180"))
dt_fcs <- study$getDataset("fcs_analyzed_result", reload=TRUE)
```

```{r eval=run_locally, echo=FALSE}
# Use the demographics table to filter data
labkey.data <- study$getDataset("demographics", reload=TRUE)
# This is a simple illustration here
labkey.data <- labkey.data[age_reported<40]
```

```{r data-subset, dependson="connection"}
# Subset plasma cells
dt_fcs19 <- dt_fcs[population_name_reported%like%"Plasma"]
dt_fcs19 <- dt_fcs19[,cohort:=gsub("Study g", "G", cohort),]
```

<!--{r subset_data, dependson="data-subset", cache.extra=list(data_input=digest::digest(labkey.data)), echo=FALSE}
## only use the selected subjets
#print(labkey.data)
#dt_fcs19 <- dt_fcs19[participant_id%in%labkey.data$participant_id]
#print(dt_fcs19)
```

{r data-summary, dependson="subset_data"}
-->
```{r data-summary, dependson="data_subset"}
# Compute median
dt_fcs19_median <- dt_fcs19[,.(median_cell_reported=median(as.double(population_cell_number)+1,na.rm=TRUE)),by=.(cohort,study_time_collected,population_name_reported)]
```


```{r dependson="subset_data;data-summary", dev="CairoPNG"}
# Flow cytometry vs. elispot
ggplot(dt_fcs19, aes(x=as.factor(study_time_collected), y=as.double(population_cell_number) + 1)) +
  geom_boxplot() + geom_jitter() + scale_y_log10() + facet_grid(cohort~population_name_reported, scale="free") +
  xlab("Time") + ylab(expression(paste("Number of cells/", mu, "l"))) +
  geom_line(data = dt_fcs19_median, aes(x=as.factor(study_time_collected), y=as.double(median_cell_reported),
    group=1), color="black",size=1.2) + labs(title="Plasma cell abundance after vaccination") + theme_IS()
```

