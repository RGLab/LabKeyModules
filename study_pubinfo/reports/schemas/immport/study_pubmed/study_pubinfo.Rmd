```{r knitr-options, echo=FALSE, eval=TRUE, cache=FALSE}
library(knitr)
opts_chunk$set(echo=FALSE, eval=TRUE, message=FALSE, warning=FALSE, error=TRUE, dev="png", fig.width=6, fig.height=4, dpi=100, autodep=FALSE)
opts_chunk$set(cache.path=paste(labkey.file.root, "cache/pubmed_report_cache/", sep="/"), cache=TRUE)
options(width=80)
```
```{r load-required-packages, cache=FALSE}
# Required librairies
library(Rlabkey)
library(rentrez)
```

```{r filter}
study_acc <- gsub(".*/", "", gsub("/@files", "", labkey.file.root))

dat <- labkey.data
ds_pubmed <- dat[dat$study_accession == study_acc, ]
```

```{r get-pubmed-info, dependson="filter"}
loaded <- labkey.selectRows(labkey.url.base, "/Shared/", "lists", "loaded_studies", colNameOpt="rname")


get_reference <- function(id, related=FALSE){
   summary <- lapply(id, function(x){ entrez_summary(db="pubmed", id=x) })
   reference <- lapply(summary, function(x){ paste(paste(x$AuthorList,collapse=", "), ". ", x$Title, " <i>", x$Source, "</i> ", x$Volume, "(", x$Issue, "), ", x$PubDate, ".", sep="")})
   pubmed_link <- paste0("<a href='http://www.ncbi.nlm.nih.gov/pubmed/", id,"' target='_blank'>", "PMID:", id,"</a>")
   if(related){
    SDY <- as.character(dat[ dat$pubmed_id == id, "study_accession"])
    folder <- loaded[loaded$study_accession == SDY, "folder"]
    SDY <- paste0("<a href='https://www.immunespace.org/project/", folder, "/", SDY ,"/begin.view?' target='_blank' title='Study ", SDY, " on ImmuneSpace'><b>  ", SDY, "  </b></a>")
    pubmed_link <- paste(pubmed_link, SDY)
   }
   return(paste(reference, pubmed_link))
}

# Update every month
id <- ds_pubmed$pubmed_id
study_citation <- get_reference(id)
pubmed_list <- entrez_link(db="all", id=id, dbfrom="pubmed")
url_citedin <- paste0("http://www.ncbi.nlm.nih.gov/pubmed?linkname=pubmed_pubmed_citedin&from_uid=", ds_pubmed$pubmed_id)
```
The above study is based on the following article(s):


<ul><li>
`r paste(study_citation, collapse="</li><br><li>")`
</li></ul>

The article has <a href=`r url_citedin` target="_blank">`r length(pubmed_list$pubmed_pubmed_citedin)` citations</a> in pubmed central. 

### Related articles in PubMed are listed below:

```{r list-related-articles, results='asis', dependson="get-pubmed-info"}
res <- lapply(pubmed_list$pubmed_pubmed[-1][1:5], get_reference, related=TRUE)
for(i in 1:5)
  {
  cat(paste0(i,". ", res[i],"\n"))
  }
url_related <- paste0("http://www.ncbi.nlm.nih.gov/pubmed?linkname=pubmed_pubmed&from_uid=", ds_pubmed$pubmed_id)
```
Click <a href=`r url_related` target="_blank">here</a> for more suggestions.
